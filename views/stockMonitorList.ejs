<!doctype html>
<html>
<head>

<style type="text/css">

table {
  border: 0;
  font-family: arial;
  font-size:10px;
  width: 100%;
  table-layout: auto;
  text-align:center;
}

table thead tr{
    display:block;
}

table th,table td{
    width:100px;//fixed width
}


table  tbody{
  display:block;
  height:500px;
  overflow:auto;//set tbody to auto
}

tr:nth-child(even) {background-color: #f2f2f2}

#div_monitor_select{
    padding: 20px;  
}

#div_monitor_select, #div_stock_list, #div_description {
     padding: 1px 20px; /*up_down, left_right */
}


</style>
  <title> <%=title%></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>      
  <script src="./js_external/echart/echarts-all.js"></script>
  <script src="./js_external/bootbox/bootbox.min.js"></script>
  <script type="text/javascript">
    

var g_monitor_list_all = <%- JSON.stringify(result) %>; 
var g_stock_info_list = g_monitor_list_all[0].monitorList;        
var g_monitor_list_all_lookup_dict = {};

function btn_remove_monitor(item)
{
    var stockId = item.value;
    console.log("Remove Stock:" + stockId);
    var URLs = "remove_stock_monitor";
    debugger;
    bootbox.confirm("Remove out monitor list", function(result) {            	
        if (result == true){                	
            var compose = {};
            compose.stockId = stockId;
            compose.name = $( "#stock_monitor_sel option:selected").text();
    		$.ajax({
		           url: URLs,
		           data: JSON.stringify(compose),
		           type:"POST",
		           dataType:'json',
		           contentType: "application/json; charset=utf-8",

		           success: function(res){
                    debugger;
                    /* Reinit g_monitor_list_all and table data. */
                    let monitor_name = $( "#stock_monitor_sel option:selected").text();   
                    g_monitor_list_all = res;
                    for(let monitor of g_monitor_list_all)
                    {              
                       g_monitor_list_all_lookup_dict[monitor.name] = monitor;  
                    }   
                    let monitor = g_monitor_list_all_lookup_dict[monitor_name];
                    var g_stock_info_id_dict = showStockDailyInfo(monitor.monitorList);                    
		                bootbox.alert("Success!");                    		                                                        
		           },
		           error:function(xhr, ajaxOptions, thrownError){                         
		                bootbox.alert("Fail!" + xhr.status + ' ' + thrownError);                
		           }
		     }); /* ajax */
		} /* if */    
	}); /* bootbox */   
}/* btn_remove_monitor */
  
function showStockDailyInfo(stock_info_list)
{
    var temp_html = '';            
    var stock_info_id_dict = {};
    var idx = 0;  
     $('#stock_info_tbl_body').empty();
    for (var stock of stock_info_list)
    {
       stock = JSON.parse(stock);	
       //console.dir(stock);
       var stockObj = stock.stockObj;
       var stockId = stock.stockId;               
       stock_info_id_dict[stockId] = idx;

       /*********************************************/
       /* Special condition */
       //debugger;
       if ((parseFloat(stockObj.stockDailyInfo.TV_times.TV_times)*10) < 13)
       {
          console.log("Skip:" + stockObj.stockInfo.stockName);
          console.log("Skip TV times:" + stockObj.stockDailyInfo.TV_times.TV_times);
          // Skip
          continue;
       }

       if ((Math.round(stockObj.stockDailyInfo.TV/1000)) < 100)
       {
          console.log("Skip:" + stockObj.stockInfo.stockName);
          console.log("Skip TV:" + Math.round(stockObj.stockDailyInfo.TV/1000));
          // Skip
          continue;
       }
       /*********************************************/
                   
       var web_link = 'https://stock.cnyes.com/market/TSE:' + stockId + ':STOCK';
      
       var type = (stockObj.stockDailyInfo.type == 'P->N')?'<font color=\"green\">跌</font>':'<font color=\"red\">漲</font>';
      
       var GS = (stockObj.stockDailyInfo.GS < 0) ?
                '<font color=\"green\">' + stockObj.stockDailyInfo.GS + '</font>' :
                '<font color=\"red\">' + stockObj.stockDailyInfo.GS + '</font>';

       var GSP = (stockObj.stockDailyInfo.GSP < 0) ?
                '<font color=\"green\">' + stockObj.stockDailyInfo.GSP + '%</font>' :
                '<font color=\"red\">' + stockObj.stockDailyInfo.GSP + '%</font>';

       var remove_btn_html = '<button type="button" class="btn btn-default btn-xs" id="stock_add_btn_' + stockId + '" value="' +
                         stockId + '" onclick="btn_remove_monitor(this)"><span class="glyphicon glyphicon-trash"></span></button>';

       var cp_html = (stockObj.stockDailyInfo.GSP < 0) ?
                     '<span class="label label-success">' + stockObj.stockDailyInfo.CP + '</span>':
                     '<span class="label label-danger">' + stockObj.stockDailyInfo.CP + '</span>';

       temp_html = '<tr>' + 
                   '<td><a target=\"_blank\" href=\"' + web_link + '\">' + stockId + '</a></td>' + 
                   '<td>' + stockObj.stockInfo.stockName + '</td>' +                           
                   '<td>' + cp_html + '</td>' + 
                   '<td>' + GS + '</td>' + 
                   '<td>' + GSP + '</td>' + 
                   '<td>' + type + '</td>' +                                                        
                   '<td>' + stockObj.stockDailyInfo.MA.MA60 + '</td>' + 
                   /*
                   '<td>' + stockObj.stockDailyInfo.MA.MA20 + '</td>' + 
                   '<td>' + stockObj.stockDailyInfo.MA.MA10 + '</td>' + 
                   '<td>' + stockObj.stockDailyInfo.MA.MA5 + '</td>' + 
                   */
                   '<td><span class="badge">' + stockObj.stockDailyInfo.TV_times.TV_times + '</span></td>' +  
                   '<td>' + Math.round(stockObj.stockDailyInfo.TV/1000) + '</td>' + 
                   '<td>' + Math.round(stockObj.stockDailyInfo.TV_times.TVMA_05/1000) + '</td>' +                            

                   '<td>' + stockObj.stockInfo.YR + '</td>' + 
                   '<td>' + stockObj.stockInfo.PRE + '</td>' + 
                   '<td>' + stockObj.stockInfo.PBR + '</td>' + 
                   '<td>' + remove_btn_html + '</td>' + 
                   '</tr>';              
       $('#stock_info_tbl_body').append(temp_html);

       idx ++;
    } /* for */
    return stock_info_id_dict;			      		
} /* showStockDailyInfo */

	$(document).ready(function(){        
        
        initHtmlContent(g_monitor_list_all);
        var g_stock_info_id_dict = showStockDailyInfo(g_stock_info_list);           
          		    
        function genMonitorSelectInfo(monitor_list_all)
        {  
            var html = '';            
            for(monitor of monitor_list_all)
            {       
                g_monitor_list_all_lookup_dict[monitor.name] = monitor;         
                html += '<option>' + monitor.name + '</option>';                
            } /* for */
            $('#stock_monitor_sel').append(html);            
        }

        function initHtmlContent(monitor_list_all)
        {               
           for(monitor of monitor_list_all)
           {
              g_monitor_list_all_lookup_dict[monitor.name] = monitor;  
           }
           genMonitorSelectInfo(monitor_list_all);
        } 

        $( "#stock_monitor_sel" ).change(function() {
          let monitor_name = $( "#stock_monitor_sel option:selected").text();         
          let monitor = g_monitor_list_all_lookup_dict[monitor_name];
          var g_stock_info_id_dict = showStockDailyInfo(monitor.monitorList);          
        });        
	}); /* document - ready() */


    </script>
</head>
<body>

<div class="row" id='div_monitor_select'>
  <div class="col-sm-3">
    <div class="form-group">
      <label for="sel1">Select list:</label>
      <select class="form-control" id="stock_monitor_sel">
        <!-- generate by genMonitorSelectInfo -->
      </select>
    </div>
  </div>
</div>

<div class="row" id="div_description">
  <div class="col-sm-10">
<!--   <span class="label label-info" id='span_monitor_name'></span> -->       
  </div>
</div> 

<div class="row" id="div_stock_list">
  <div class="col-sm-10">
  <table class="table">  
    <thead class="thead-inverse">    
     <tr>
        <th>ID</th>
        <th>Name</th>
        <th>收盤價</th>         
        <th>漲跌</th>
        <th>漲跌幅</th>
        <th>Type</th>              
        <th>MA60</th>
<!--    <th>MA20</th> -->
<!--    <th>MA10</th> -->
<!--    <th>MA5</th> -->
        <th>成交量比</th>
        <th>成交量</th>
        <th>前五日成交量</th>        
        <th>殖利率</th>
        <th>本益比</th>
        <th>股價淨值比</th>       
        <th>Action</th>
      </tr>
    </thead>
    <tbody id='stock_info_tbl_body'>
      <!-- generate by showStockDailyInfo -->
    </tbody>
  </table>
  </div>
</div>
</body>
</html>